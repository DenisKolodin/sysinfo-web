<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>sysinfo-web</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/simplex/bootstrap.min.css" type="text/css" media="screen"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.2.6/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-chartjs/2.6.2/vue-chartjs.full.min.js"></script>
<style type="text/css" media="screen">
h2 {
    font-size: 1.2em;
    text-align: center;
}
div.sort {
    cursor: pointer;
}
hr.global-cpu-divider {
    margin-top: 0;
}
</style>
</head>
<body>
<div id="sysinfo" class="container" v-if="sysinfo">
    <h2>{{ sysinfo.hostname }} &mdash; {{ sysinfo.uptime }}</h2>
    <hr/>
    <line-chart :chart-data="processorUsageHistory.chartData"></line-chart>
    <hr/>
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">CPU Usage</div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-2">Global</div>
                        <div class="col-xs-10">
                            <div class="progress">
                                <div class="progress-bar progress-bar-info" :style="'width: ' + (sysinfo.processor_list[0].cpu_usage * 100) + '%'"></div>
                            </div>
                        </div>
                    </div>
                    <hr class="global-cpu-divider">
                    <div class="row" v-for="processor in sysinfo.processor_list.slice(1)">
                        <div class="col-xs-2">{{ processor.name }}</div>
                        <div class="col-xs-10">
                            <div class="progress">
                                <div class="progress-bar progress-bar-info" :style="'width: ' + (processor.cpu_usage * 100) + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Disks</div>
                <div class="panel-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <td>Name</td>
                                <td>MP</td>
                                <td>FS</td>
                                <td>Size</td>
                                <td>Used</td>
                                <td>Avail</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="disk in sysinfo.disks">
                                <td>{{ disk.name }}</td>
                                <td>{{ disk.mount_point }}</td>
                                <td>{{ disk.file_system }}</td>
                                <td>{{ disk.total_space | readableBytes }}</td>
                                <td>{{ disk.total_space - disk.available_space | readableBytes }}</td>
                                <td>{{ disk.available_space | readableBytes }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">Memory Usage</div>
                <div class="panel-body">
                    <div class="progress">
                        <div class="progress-bar progress-bar-info" :style="'width: ' + (sysinfo.memory[1] * 100 / sysinfo.memory[0]) + '%'"></div>
                    </div>
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <td></td>
                                <td>Total</td>
                                <td>Used</td>
                                <td>Free</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Memory</td>
                                <td>{{ sysinfo.memory[0] | readableKbytes }}</td>
                                <td>{{ sysinfo.memory[1] | readableKbytes }}</td>
                                <td>{{ sysinfo.memory[2] | readableKbytes }}</td>
                            </tr>
                            <tr>
                                <td>Swap</td>
                                <td>{{ sysinfo.memory[3] | readableKbytes }}</td>
                                <td>{{ sysinfo.memory[4] | readableKbytes }}</td>
                                <td>{{ sysinfo.memory[5] | readableKbytes }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Components</div>
                <div class="panel-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <td>Label</td>
                                <td>Temperature</td>
                                <td>Max</td>
                                <td>Critical</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="component in sysinfo.components_list">
                                <td>{{ component.label }}</td>
                                <td>{{ component.temperature }} &deg;C</td>
                                <td>{{ component.max }} &deg;C</td>
                                <td v-if="component.critical && component.critical != ''">{{ component.critical }} &deg;C</td>
                                <td v-else></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="panel panel-default">
                <div class="panel-heading">Processes</div>
                <div class="panel-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th v-for="(c, column) in columns">
                                    <div v-on:click="sortBy(column)"
                                         v-bind:class="{ 'text-info': sortKey == columns[column] && reverse,
                                                         'text-warning': sortKey == columns[column] && !reverse,
                                                         'sort': true }">{{ column }}</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="process in sorter">
                                <td>{{ process.pid }}</td>
                                <td>{{ process.name | truncate }}</td>
                                <td>{{ process.uid }}</td>
                                <td>{{ process.gid }}</td>
                                <td>{{ process.cpu_usage | round }}%</td>
                                <td>{{ process.memory | readableKbytes }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

var sysinfo = new Vue({
    el: '#sysinfo',
    components: {
        "line-chart": {
            extends: VueChartJs.Line,
            mixins: [VueChartJs.mixins.reactiveProp],
            mounted: function() {
                this.renderChart(this.chartData, {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{ ticks: { max: 100, min: 0 }}]
                    },
                });
            }
        },
    },
    data: {
        columns: {"PID": "pid", "Name": "name", "UID": "uid", "GID": "gid", "CPU": "cpu_usage", "Memory": "memory"},
        sortKey: "cpu_usage",
        processorUsageHistory: {
            chartData: null,
            history: [],
        },
        reverse: true,
        sysinfo: null,
        update_interval: 5000, // milliseconds
        chart_length: 300,     // seconds
    },
    created: function() {
        this.fetchData();
        setInterval(function() {
            this.fetchData();
        }.bind(this), this.update_interval); 
    },
    methods: {
        fetchData: function() {
            var xhr = new XMLHttpRequest();
            var self = this;
            xhr.open('GET', 'sysinfo.json');
            xhr.onload = function() {
                self.sysinfo = JSON.parse(xhr.responseText);
                var values = [];
                for (proc in self.sysinfo.process_list) {
                    values.push(self.sysinfo.process_list[proc]);
                }
                self.sysinfo.process_list = values;
                self.addProcessorUsageHistory(self.sysinfo.processor_list.slice(1));
            }
            xhr.send();
        },
        addProcessorUsageHistory: function(data) {
            var self = this;
            var processor_list = [];
            for (processor in data) {
                processor_list.push({
                    name: data[processor].name,
                    usage: Math.floor(data[processor].cpu_usage * 100),
                    time: new Date(),
                });
            }
            self.processorUsageHistory.history.push(processor_list);
            if (self.processorUsageHistory.history.length > self.chart_length / (self.update_interval / 1000)) {
                self.processorUsageHistory.history.shift();
            }
            self.updateProcessorUsageHistoryChartData();
        },
        updateProcessorUsageHistoryChartData: function() {
            var self = this;
            var labels = [];
            var datasets = [];
            var colors = [
              'rgb(217, 35, 15)', 'rgb(192, 152, 83)', 'rgb(185, 74, 72)', 'rgb(70, 136, 71)', 'rgb(58, 135, 173)'
            ];

            for (processor_index in self.processorUsageHistory.history[0]) {
                var history = [];
                for (i in self.processorUsageHistory.history) {
                    history.push(self.processorUsageHistory.history[i][processor_index].usage);
                }
                datasets.push({
                    label: self.processorUsageHistory.history[0][processor_index].name,
                    data: history,
                    borderColor: colors[processor_index % 5],
                });
            }

            for (var i = 0; i <= self.chart_length; i = i + 5) {
                var future = new Date(self.processorUsageHistory.history[0][0].time);
                future.setSeconds(future.getSeconds() + i);
                if (i % 60 == 0) {
                    labels.push(('0' + future.getHours()).slice(-2) + ':' +
                                ('0' + future.getMinutes()).slice(-2) + ':' +
                                ('0' + future.getSeconds()).slice(-2));
                } else  {
                    labels.push('');
                }
            }

            self.processorUsageHistory.chartData = {
                labels: labels,
                datasets: datasets,
            };
        },
        sortBy: function(sortKey) {
            this.reverse = (this.sortKey == this.columns[sortKey]) ? ! this.reverse : true;
            this.sortKey = this.columns[sortKey];
        },
    },
    computed: {
        sorter: function() {
            if (this.sysinfo == null) {
                return [];
            }
            var self = this;
            var order = self.reverse ? -1 : 1;
            return this.sysinfo.process_list.sort(function(a, b) {
                a = a[self.sortKey];
                b = b[self.sortKey];
                return (a === b ? 0 : a > b ? 1 : -1) * order;
            });
        },
    },
    filters: {
        readableKbytes: function(kbytes) {
            var thresh = 1024;
            if(Math.abs(kbytes) < thresh) {
                return kbytes + ' kiB';
            }
            var units = ['MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
            var u = -1;
            do {
                kbytes /= thresh;
                ++u;
            } while(Math.abs(kbytes) >= thresh && u < units.length - 1);
            return kbytes.toFixed(1) + ' ' + units[u];
        },
        readableBytes: function(bytes) {
            var thresh = 1024;
            if(Math.abs(bytes) < thresh) {
                return bytes + ' B';
            }
            var units = ['KiB', 'MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
            var u = -1;
            do {
                bytes /= thresh;
                ++u;
            } while(Math.abs(bytes) >= thresh && u < units.length - 1);
            return bytes.toFixed(1) + ' ' + units[u];
        },
        truncate: function(val) {
            return val.substring(0, 100);
        },
        round: function(val) {
            return Math.round(val)
        },
    },
});
    
</script>
</body>
</html>
